---
title: "IGT Data Cleaning & Exploration Report (No RT)"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    theme: flatly
date: "2025-10-15"
---
This R Markdown template is designed for exploring and cleaning trial-level data from Iowa Gambling Task (IGT) variants **when response time data is not available**. The process is broken into several steps:

* **Setup**: Load libraries and data, and define initial parameters.
* **Subject-Level Compliance**: Calculate and review metrics like trial completion.
* **Exploratory Behavioral Metrics**: Investigate response patterns like choice perseveration and entropy to understand participant strategies without prematurely filtering.
* **Final Filtering & Saving**: Apply the cleaning criteria you've decided upon and save the final lists of included and excluded subjects.

# 1. Setup
Load libraries, read in the raw data file, and set the initial cleaning parameters. You should adjust the parameters in this chunk based on your specific task and initial data exploration.
```{r}
# Load necessary libraries
suppressPackageStartupMessages({
  library(tidyverse)
  library(knitr)
})

# --- Parameters to Set ---
# Define the path to your raw data file
# EXAMPLE: data_file_path <- "path/to/your/data.csv"

task = "igt"
cohort = "luc"
ses = "00"

data_file_path <- paste0("~/Dropbox/Projects/cognitive-choice-modeling/Data/raw/", cohort, "/", task, "_", cohort, "_", ses, ".csv")

# Subject-level Inclusion Criteria
MIN_TRIAL_COUNT <- 80 # Minimum number of trials a subject must have to be included

# Task Structure
TOTAL_TRIALS <- 100 # Adjust for standard IGT (100) or HDT (200)
NUM_BLOCKS <- 5 # How many blocks to divide the task into for entropy analysis


# --- Load Data ---
# Read the data file. The script will stop if the file isn't found.
if (file.exists(data_file_path)) {
  data_raw <- read_csv(data_file_path, show_col_types = FALSE)
  
  # Standardize column names (e.g., 'sid', 'subjID' -> 'subject')
  # Add more standardization as needed for your files
  if ("subject" %in% names(data_raw) | "sid" %in% names(data_raw)) {
    data_raw <- data_raw %>%
      rename_with(~"subjID", any_of(c("sid", "subject")))
    }

} else {
  stop("Data file not found. Please update 'data_file_path' in the setup chunk.")
}

# Define a function to calculate Shannon entropy
calculate_entropy <- function(choices) {
  # Calculate probability of each choice
  prob <- prop.table(table(choices))
  # Calculate entropy (base 2)
  # -sum(p * log2(p))
  -sum(prob * log2(prob))
}
```


# 2. Subject-Level Compliance
Here, we aggregate the data by subject to see who completed the task. We calculate the total number of trials for each subject.
```{r}
# Calculate compliance metrics for each subject
subject_summary <- data_raw %>%
  group_by(subjID) %>%
  summarise(
    n_total_trials = n(),
    .groups = 'drop'
  )

# Plot the distribution of trial counts per subject
trial_count_histogram <- ggplot(subject_summary, aes(x = n_total_trials)) +
  geom_histogram(bins = 30, fill = "lightgreen", color = "black") +
  geom_vline(xintercept = MIN_TRIAL_COUNT, color = "red", linetype = "dashed", size = 1) +
  annotate("text", x = MIN_TRIAL_COUNT, y = Inf, label = paste0("Min: ", MIN_TRIAL_COUNT), vjust = 2, hjust = -0.1, color = "red") +
  ggtitle("Distribution of Trial Counts per Subject") +
  xlab("Number of Trials Completed") +
  ylab("Number of Subjects") +
  theme_bw()

print(trial_count_histogram)


# Display summary statistics and quantiles for trial counts
cat("--- Summary of Trial Counts ---\n")
print(summary(subject_summary$n_total_trials))

cat("\n--- Quantiles of Trial Counts ---\n")
print(quantile(subject_summary$n_total_trials, probs = c(.01, .05, .10, .25, .50, .75, .90, .95, .99)))

# Flag subjects with incomplete data
incomplete_subjects <- subject_summary %>%
  filter(n_total_trials < TOTAL_TRIALS)

cat("\n--- Subjects with Incomplete Data (< ", TOTAL_TRIALS, " trials) ---\n", sep = "")
cat("Number of subjects: ", nrow(incomplete_subjects), "\n")
if(nrow(incomplete_subjects) > 0 & nrow(incomplete_subjects) <= 20) {
  print(incomplete_subjects)
} else if (nrow(incomplete_subjects) > 20) {
  cat("Too many to display; check subject_summary dataframe\n")
}
```


# 3. Exploratory Behavioral Metrics
This section is for investigating participant behavior before making final exclusion decisions.

## A. Choice Perseveration
We check if any subjects chose the same deck an overwhelming majority of the time, which could indicate non-engagement.
```{r}
# Calculate the proportion of the most-chosen deck for each subject
choice_summary <- data_raw %>%
  group_by(subjID) %>%
  summarise(
    max_deck_prop = max(prop.table(table(choice))),
    .groups = 'drop'
  )

# Plot the distribution of this metric
max_deck_prop_hist <- ggplot(choice_summary, aes(x = max_deck_prop)) +
  geom_histogram(bins = 30, fill = "coral", color = "black") +
  ggtitle("Distribution of Max Deck Choice Proportion") +
  xlab("Proportion of Most-Chosen Deck") +
  ylab("Number of Subjects") +
  scale_x_continuous(labels = scales::percent) +
  theme_bw()

print(max_deck_prop_hist)

# Display summary statistics and quantiles
cat("--- Summary of Max Deck Choice Proportion ---\n")
print(summary(choice_summary$max_deck_prop))

cat("\n--- Quantiles of Max Deck Choice Proportion ---\n")
print(quantile(choice_summary$max_deck_prop, probs = c(0, .05, .5, .95, .99, 1)))

# Show detailed choice patterns for subjects with high perseveration (>85%)
high_perseveration_subjects <- choice_summary %>%
  filter(max_deck_prop > .85)

if(nrow(high_perseveration_subjects) > 0) {
  cat("\n--- Subjects with High Perseveration (>85% one deck) ---\n")
  cat("Number of subjects: ", nrow(high_perseveration_subjects), "\n\n")
  
  high_persev_details <- data_raw %>%
    filter(subjID %in% high_perseveration_subjects$subjID) %>%
    count(subjID, choice) %>%
    group_by(subjID) %>%
    mutate(deck_prop = n / sum(n)) %>%
    ungroup() %>%
    arrange(subjID, desc(deck_prop))
  
  print(high_persev_details)
}
```

## B. Mean Choice Entropy
We calculate choice entropy across blocks to see how random or structured choices were. High entropy (~2.0 for 4 decks) suggests random exploration, while low entropy suggests a focused strategy.
```{r}
# Create blocks
block_size <- TOTAL_TRIALS / NUM_BLOCKS
entropy_summary <- data_raw %>%
  group_by(subjID) %>%
  mutate(block = ceiling(trial / block_size)) %>%
  group_by(subjID, block) %>%
  summarise(
    entropy = calculate_entropy(choice),
    .groups = 'drop'
  ) %>%
  group_by(subjID) %>%
  summarise(
    mean_entropy = mean(entropy, na.rm = TRUE),
    .groups = 'drop'
  )

# Plot the distribution of mean entropy
mean_entropy_hist <- ggplot(entropy_summary, aes(x = mean_entropy)) +
  geom_histogram(bins = 30, fill = "gold", color = "black") +
  geom_vline(xintercept = 2, color = "blue", linetype = "dashed", size = 1) +
  annotate("text", x = 2, y = Inf, label = "Max Entropy (Random)", vjust = 2, hjust = 1.1, color = "blue") +
  ggtitle("Distribution of Mean Choice Entropy per Subject") +
  xlab("Mean Entropy (log2)") +
  ylab("Number of Subjects") +
  theme_bw()

print(mean_entropy_hist)

# Display summary statistics and quantiles
cat("--- Summary of Mean Choice Entropy ---\n")
print(summary(entropy_summary$mean_entropy))

cat("\n--- Quantiles of Mean Choice Entropy ---\n")
print(quantile(entropy_summary$mean_entropy, probs = c(0, .05, .25, .50, .75, .95, 1)))
```

# 4. Final Filtering & Saving
**This section is intentionally not run by default.**

After reviewing the summaries and plots above, you can finalize your criteria in the setup chunk and then uncomment and run the code below to generate the clean dataset and the lists of included/excluded subjects.
```{r}
# --- Step 1: Join all subject-level metrics together ---
subjects_final <- subject_summary %>%
  left_join(choice_summary, by = "subjID") %>%
  left_join(entropy_summary, by = "subjID")

# --- Step 2: Define the inclusion criteria ---
# These rules use the parameters defined in the 'setup' chunk.
# You can add or remove rules as needed (e.g., entropy thresholds).
subjects_final <- subjects_final %>%
  mutate(
    is_retained = 
      n_total_trials >= MIN_TRIAL_COUNT &
      max_deck_prop < 0.95
  )

# --- Step 3: Report the outcome ---
orig_num <- nrow(subjects_final)
retained_num <- sum(subjects_final$is_retained)
excluded_num <- orig_num - retained_num
retained_pct <- retained_num / orig_num

cat("--- Data Cleaning Summary ---\n")
cat("Original number of subjects:      ", orig_num, "\n")
cat("Subjects retained after cleaning: ", retained_num, "\n")
cat("Subjects excluded:                ", excluded_num, "\n")
cat("Percentage of subjects retained:  ", scales::percent(retained_pct), "\n")

# Show breakdown of why subjects were excluded
exclusion_reasons <- subjects_final %>%
  filter(is_retained == FALSE) %>%
  summarise(
    low_trial_count = sum(n_total_trials < MIN_TRIAL_COUNT),
    high_perseveration = sum(max_deck_prop >= 0.95)
  )

cat("\n--- Exclusion Reason Breakdown ---\n")
cat("(Note: subjects can be excluded for multiple reasons)\n")
print(exclusion_reasons)


# --- Step 4: Create the final clean dataset and ID lists ---
# Get the list of subject IDs to keep
retained_sids <- subjects_final %>%
  filter(is_retained == TRUE) %>%
  pull(subjID)

# Get the list of subject IDs to drop
excluded_sids <- subjects_final %>%
  filter(is_retained == FALSE) %>%
  pull(subjID)

# Create the final clean trial-level dataset
data_clean <- data_raw %>%
  filter(subjID %in% retained_sids)

# --- Step 5: Save the output files ---
# Define output directory and filenames
output_dir <- file.path(dirname(data_file_path), 
                        paste0("ses-", ses)) # Saves in the ses folder
filename_retained_ids <- file.path(output_dir, "subjects_retained_list.txt")
filename_excluded_ids <- file.path(output_dir, "subjects_excluded_list.txt")

# Create output directory if it doesn't exist
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}

# Save the subject ID lists
writeLines(as.character(retained_sids), filename_retained_ids)
writeLines(as.character(excluded_sids), filename_excluded_ids)

cat("\n--- Files Saved ---\n")
cat("Retained IDs saved to:    ", filename_retained_ids, "\n")
cat("Excluded IDs saved to:    ", filename_excluded_ids, "\n")
```

# EOF
```{r}
```
