## PPC Performance by Model

```{r ppc-model-summary}
if ("ppc" %in% names(analysis_results) && nrow(analysis_results$ppc$model_summary) > 0) {
  model_ppc <- analysis_results$ppc$model_summary %>%
    arrange(overall_proportion_extreme) %>%
    mutate(across(where(is.numeric), ~round(.x, 3)))
  
  DT::datatable(model_ppc, 
                caption = "PPC Performance by Model",
                options = list(pageLength = 15, scrollX = TRUE)) %>%
    DT::formatStyle("model_quality",
                    backgroundColor = DT::styleEqual(
                      c("excellent", "good", "acceptable", "concerning", "poor"),
                      c("#d4edda", "#d1ecf1", "#fff3cd", "#ffeaa7", "#f8d7da")
                    ))
}
```

## PPC Performance by Behavioral Domain

```{r ppc-domain-summary}
if ("ppc" %in% names(analysis_results) && nrow(analysis_results$ppc$domain_summary) > 0) {
  domain_summary <- analysis_results$ppc$domain_summary %>%
    arrange(proportion_extreme) %>%
    mutate(across(where(is.numeric), ~round(.x, 3)))
  
  DT::datatable(domain_summary, 
                caption = "PPC Performance by Behavioral Domain",
                options = list(pageLength = 10, scrollX = TRUE)) %>%
    DT::formatStyle("domain_quality",
                    backgroundColor = DT::styleEqual(
                      c("excellent", "good", "acceptable", "concerning", "poor"),
                      c("#d4edda", "#d1ecf1", "#fff3cd", "#ffeaa7", "#f8d7da")
                    ))
} else {
  cat("No PPC domain results available.")
}
```

## PPC Visualizations

```{r ppc-plots, fig.height=10}
if ("ppc" %in% names(analysis_results)) {
  # Create PPC plots
  ppc_plots <- generate_all_ppc_plots(analysis_results$ppc, models_by_type, params$task)
  
  # Display domain heatmap
  if (!is.null(ppc_plots$domain_heatmap)) {
    print(ppc_plots$domain_heatmap)
  }
  
  # Display extreme failures
  if (!is.null(ppc_plots$failure_summary)) {
    print(ppc_plots$failure_summary)
  }
  
  # Display behavioral patterns
  if (!is.null(ppc_plots$domain_difficulty)) {
    print(ppc_plots$domain_difficulty)
  }
}
```

## Extreme PPC Failures

```{r ppc-extreme-failures}
if ("ppc" %in% names(analysis_results) && nrow(analysis_results$ppc$extreme_failures) > 0) {
  # Summarize extreme failures
  failure_summary <- analysis_results$ppc$extreme_failures %>%
    count(model, model_type, failure_severity, name = "n_failures") %>%
    pivot_wider(names_from = failure_severity, values_from = n_failures, values_fill = 0) %>%
    arrange(desc(severe), desc(moderate), desc(mild))
  
  DT::datatable(failure_summary, 
                caption = "Extreme PPC Failures by Model and Severity",
                options = list(pageLength = 15, scrollX = TRUE))
  
  # Most problematic statistics
  cat("\n\n### Most Problematic Statistics\n\n")
  
  problem_stats <- analysis_results$ppc$extreme_failures %>%
    count(statistic, failure_severity) %>%
    pivot_wider(names_from = failure_severity, values_from = n, values_fill = 0) %>%
    mutate(total_failures = severe + moderate + mild) %>%
    arrange(desc(total_failures)) %>%
    head(10)
  
  kable(problem_stats, caption = "Statistics with Most Extreme PPP Failures") %>%
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))
  
} else {
  cat("No extreme PPC failures detected across all models.")
}
```

## Behavioral Pattern Analysis

```{r ppc-behavioral-patterns}
if ("ppc" %in% names(analysis_results) && "behavioral_patterns" %in% names(analysis_results$ppc)) {
  patterns <- analysis_results$ppc$behavioral_patterns
  
  # Difficult domains
  if ("difficult_domains" %in% names(patterns) && nrow(patterns$difficult_domains) > 0) {
    cat("### Most Challenging Behavioral Domains\n\n")
    
    difficult_table <- patterns$difficult_domains %>%
      arrange(desc(mean_proportion_extreme)) %>%
      mutate(across(where(is.numeric), ~round(.x, 3)))
    
    kable(difficult_table, caption = "Challenging Domains by Model Type") %>%
      kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))
    cat("\n\n")
  }
  
  # RT performance by type (if available)
  if ("rt_performance_by_type" %in% names(patterns) && nrow(patterns$rt_performance_by_type) > 0) {
    cat("### RT Performance by Model Type\n\n")
    
    rt_table <- patterns$rt_performance_by_type %>%
      arrange(mean_proportion_extreme) %>%
      mutate(across(where(is.numeric), ~round(.x, 3)))
    
    kable(rt_table, caption = "RT Pattern Reproduction by Model Type") %>%
      kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))
    cat("\n\n")
  }
  
  # Learning performance by type (if available)
  if ("learning_performance_by_type" %in% names(patterns) && nrow(patterns$learning_performance_by_type) > 0) {
    cat("### Learning Dynamics Performance by Model Type\n\n")
    
    learning_table <- patterns$learning_performance_by_type %>%
      arrange(mean_proportion_extreme) %>%
      mutate(across(where(is.numeric), ~round(.x, 3)))
    
    kable(learning_table, caption = "Learning Pattern Reproduction by Model Type") %>%
      kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))
    cat("\n\n")
  }
  
  # Best/worst models by domain
  if ("model_performance_by_domain" %in% names(patterns) && nrow(patterns$model_performance_by_domain) > 0) {
    cat("### Best and Worst Models by Domain\n\n")
    
    domain_table <- patterns$model_performance_by_domain %>%
      mutate(across(where(is.numeric), ~round(.x, 3)))
    
    kable(domain_table, caption = "Model Performance Range by Behavioral Domain") %>%
      kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))
  }
}
```
