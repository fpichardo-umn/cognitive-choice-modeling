---
title: "MCMC Diagnostics Report - Hierarchical Model"
subtitle: "{{MODEL}} - {{TASK}} - {{COHORT}} ({{N_SUBJECTS}} subjects)"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    theme: flatly
    highlight: tango
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)

# Load required libraries
suppressPackageStartupMessages({
  library(ggplot2)
  library(dplyr)
  library(knitr)
  library(here)
})

# Source helper functions
source(file.path(here::here(), "scripts", "diagnostics", "helpers", "diagnostic_helpers.R"))

# Load diagnostic results
diagnostic_results <- readRDS("{{DIAGNOSTIC_FILE}}")

# Load thresholds
thresholds <- load_diagnostic_thresholds()
```

---

# Executive Summary

## Overall Status

```{r overall-status, results='asis'}
status <- diagnostic_results$overall_status
cat(format_status_badge(status))
```

## Model Information

```{r model-info}
info_df <- data.frame(
  Item = c("Task", "Cohort", "Model", "Fit Type", "Subjects"),
  Value = c(
    "{{TASK}}",
    "{{COHORT}}",
    "{{MODEL}}",
    diagnostic_results$fit_type,
    as.character(diagnostic_results$n_subjects)
  ),
  stringsAsFactors = FALSE
)

kable(info_df, col.names = NULL)
```

## Quick Summary

```{r quick-summary}
subj_agg <- diagnostic_results$subject_analysis$aggregate

summary_df <- data.frame(
  Metric = c("Subject Parameters", "Subjects PASS", "Subjects WARN", "Subjects FAIL", "Overall"),
  Value = c(
    sprintf("%.0f params/subject", subj_agg$n_params_per_subject),
    sprintf("%d subjects", subj_agg$status$pass),
    sprintf("%d subjects", subj_agg$status$warn),
    sprintf("%d subjects", subj_agg$status$fail),
    diagnostic_results$overall_status
  ),
  stringsAsFactors = FALSE
)

kable(summary_df, col.names = c("", ""))
```

**Bottom Line:** `r if(diagnostic_results$overall_status == "PASS") "✓ Hierarchical model diagnostics look good. Subject-level parameters have converged." else if(diagnostic_results$overall_status == "WARN") "⚠ Some subjects have diagnostic warnings. Review the details below." else "✗ Significant diagnostic issues. Address problems before proceeding."`

---

# Group-Level Parameters

This section shows diagnostics for non-subject parameters: hyperparameters (`mu_pr`, `sigma`), generated quantities (`mu_*`), and the log posterior (`lp__`).

```{r group-level-params}
if (!is.null(diagnostic_results$group_analysis)) {
  group_info <- diagnostic_results$group_analysis
  
  cat(sprintf("- **Total group-level parameters**: %d\n", group_info$n_params))
  cat(sprintf("- **All converged (R-hat < %.2f)**: %s\n", 
              thresholds$thresholds$rhat$acceptable,
              ifelse(group_info$rhat$all_converged, "Yes", "No")))
  cat(sprintf("- **Worst R-hat**: %.4f\n", group_info$rhat$max))
  if (!is.null(group_info$ess_bulk)) {
    cat(sprintf("- **Min ESS Bulk**: %.0f\n", group_info$ess_bulk$min))
  }
  if (!is.null(group_info$ess_tail)) {
    cat(sprintf("- **Min ESS Tail**: %.0f\n", group_info$ess_tail$min))
  }
  cat(sprintf("- **Status**: %s\n\n", group_info$status))
  
  if (group_info$status != "PASS") {
    cat("⚠ **Warning**: Group-level parameters have convergence issues. This affects population-level inference.\n\n")
  }
} else if (!is.null(diagnostic_results$basic_checks$hyperparameters)) {
  hyper <- diagnostic_results$basic_checks$hyperparameters
  
  cat(sprintf("- **Converged**: %s\n", ifelse(hyper$converged, "Yes", "No")))
  cat(sprintf("- **Worst R-hat**: %.4f\n", hyper$worst_rhat))
  cat(sprintf("- **Status**: %s\n\n", hyper$status))
  
  if (!hyper$converged) {
    cat("⚠ **Warning**: Hyperparameters have not fully converged. This affects all subject-level estimates.\n\n")
  }
} else {
  cat("*Group-level parameter diagnostics not available*\n\n")
}
```

## Detailed Group-Level Parameter Table

```{r group-param-table}
if (!is.null(diagnostic_results$group_analysis)) {
  group_info <- diagnostic_results$group_analysis
  
  # Build detailed table
  group_df <- data.frame(
    Parameter = group_info$parameters,
    Category = unname(group_info$param_categories[group_info$parameters]),
    Rhat = sprintf("%.4f", group_info$rhat$values[group_info$parameters]),
    stringsAsFactors = FALSE
  )
  
  if (!is.null(group_info$ess_bulk)) {
    group_df$ESS_Bulk <- sprintf("%.0f", group_info$ess_bulk$values[group_info$parameters])
  }
  
  if (!is.null(group_info$ess_tail)) {
    group_df$ESS_Tail <- sprintf("%.0f", group_info$ess_tail$values[group_info$parameters])
  }
  
  # Add status column based on thresholds
  group_df$Status <- sapply(group_info$parameters, function(p) {
    rhat_val <- group_info$rhat$values[p]
    ess_bulk_val <- if (!is.null(group_info$ess_bulk)) group_info$ess_bulk$values[p] else Inf
    ess_tail_val <- if (!is.null(group_info$ess_tail)) group_info$ess_tail$values[p] else Inf
    
    if (rhat_val > thresholds$thresholds$rhat$problematic ||
        ess_bulk_val < thresholds$thresholds$ess_bulk$critical ||
        ess_tail_val < thresholds$thresholds$ess_tail$critical) {
      "FAIL"
    } else if (rhat_val > thresholds$thresholds$rhat$acceptable ||
               ess_bulk_val < thresholds$thresholds$ess_bulk$acceptable ||
               ess_tail_val < thresholds$thresholds$ess_tail$acceptable) {
      "WARN"
    } else {
      "PASS"
    }
  })
  
  # Reorder to show problematic ones first
  group_df <- group_df[order(factor(group_df$Status, levels = c("FAIL", "WARN", "PASS")), 
                              group_df$Category), ]
  
  kable(group_df, row.names = FALSE)
} else {
  cat("*Detailed group-level parameter table not available*\n")
}
```

**Parameter Categories:**

- **log_posterior**: `lp__` - overall model fit quality
- **hyper_mean**: `mu_pr[*]` - population means (on transformed scale)
- **hyper_sd**: `sigma[*]` - population standard deviations
- **generated_mu**: `mu_*` - transformed population means (interpretable scale)

---

# Subject-Level Parameters

## R-hat Distribution Across Subjects

```{r subject-rhat}
subj_agg <- diagnostic_results$subject_analysis$aggregate

cat(sprintf("- **Minimum (best)**: %.4f\n", subj_agg$rhat$min))
cat(sprintf("- **Maximum (worst)**: %.4f\n", subj_agg$rhat$max))
cat(sprintf("- **Median**: %.4f\n", subj_agg$rhat$median))
cat(sprintf("- **Subjects with R-hat > %.2f**: %d\n\n", 
            thresholds$thresholds$rhat$problematic, subj_agg$rhat$n_problematic))
```

**Interpretation:** Each subject has their own set of parameters. This shows the worst R-hat value for each subject.

## ESS Distribution Across Subjects

```{r subject-ess}
cat("### ESS Bulk (Center of Distribution)\n\n")
cat(sprintf("- **Minimum (worst)**: %.0f\n", subj_agg$ess_bulk$min))
cat(sprintf("- **Median**: %.0f\n", subj_agg$ess_bulk$median))
cat(sprintf("- **Subjects with ESS_bulk < %d**: %d\n\n", 
            thresholds$thresholds$ess_bulk$critical, subj_agg$ess_bulk$n_critical))

cat("### ESS Tail (Quantiles/Extremes)\n\n")
cat(sprintf("- **Minimum (worst)**: %.0f\n", subj_agg$ess_tail$min))
cat(sprintf("- **Median**: %.0f\n", subj_agg$ess_tail$median))
cat(sprintf("- **Subjects with ESS_tail < %d**: %d\n\n", 
            thresholds$thresholds$ess_tail$critical, subj_agg$ess_tail$n_critical))

cat("**Note:** ESS counts matter for validity (need >100 absolute). Low counts = unreliable estimates.\n")
```

## Status Distribution

```{r status-dist}
status_df <- data.frame(
  Status = c("PASS", "WARN", "FAIL"),
  Count = c(subj_agg$status$pass, subj_agg$status$warn, subj_agg$status$fail),
  Percentage = sprintf("%.1f%%", 
                      c(subj_agg$status$pass, subj_agg$status$warn, subj_agg$status$fail) / 
                      diagnostic_results$n_subjects * 100),
  stringsAsFactors = FALSE
)

kable(status_df)
```

---

# Worst Subjects

These subjects have the most diagnostic issues:

```{r worst-subjects}
if (!is.null(diagnostic_results$subject_analysis$subject_summaries)) {
  # Convert list to data frame
  df <- diagnostic_results$subject_analysis$subject_summaries
  df <- do.call(rbind, lapply(df, as.data.frame))
  
  # Filter to non-PASS subjects only
  df_problems <- df %>%
    filter(status != "PASS") %>%
    arrange(desc(problem_score))
  
  if (nrow(df_problems) > 0) {
    display_df <- df_problems %>%
      select(subject_id, status, worst_rhat, min_ess_bulk, min_ess_tail, problem_score) %>%
      mutate(
        worst_rhat = sprintf("%.4f", worst_rhat),
        min_ess_bulk = sprintf("%.0f", ifelse(is.na(min_ess_bulk), 0, min_ess_bulk)),
        min_ess_tail = sprintf("%.0f", ifelse(is.na(min_ess_tail), 0, min_ess_tail)),
        problem_score = sprintf("%.1f", problem_score)
      )
    
    kable(display_df, row.names = FALSE,
          col.names = c("Subject", "Status", "Worst R-hat", "Min ESS Bulk", "Min ESS Tail", "Problem Score"))
  } else {
    cat("✓ **All subjects passed diagnostics!**\n")
  }
} else {
  cat("*Subject summaries not available*\n")
}
```

---

# Divergences

```{r divergences}
if (!is.null(diagnostic_results$basic_checks$divergences)) {
  div <- diagnostic_results$basic_checks$divergences
  
  cat(sprintf("- **Count**: %.0f\n", div$count))
  cat(sprintf("- **Rate**: %.4f%%\n", div$rate * 100))
  cat(sprintf("- **Status**: %s\n\n", div$status))
  
  if (div$status != "PASS") {
    cat("⚠ **Action needed**: High divergence rate in hierarchical model often indicates:\n")
    cat("- Funnel geometry (common in hierarchical models)\n")
    cat("- **Solution**: Use non-centered parameterization\n")
    cat("- Increase adapt_delta to 0.99+\n\n")
  }
} else {
  cat("*Divergence information not available*\n\n")
}
```

---

# Shrinkage Assessment

```{r shrinkage}
if (!is.null(diagnostic_results$shrinkage_check)) {
  shrink <- diagnostic_results$shrinkage_check
  
  if (shrink$working) {
    cat("✓ **Hierarchical shrinkage appears to be working.**\n\n")
    cat("Parameter variation across subjects:\n\n")
    
    for (param_name in names(shrink$parameter_info)) {
      param_info <- shrink$parameter_info[[param_name]]
      cat(sprintf("- **%s**: Range = %.3f, CV = %.3f\n", 
                  param_name, param_info$range, param_info$cv))
    }
    cat("\n")
    
    cat("**What this means:** Parameters vary across subjects (not all identical), indicating the hierarchical structure is functioning. Coefficient of variation (CV) shows relative variability.\n\n")
  } else {
    cat("⚠ **Unable to assess shrinkage** - check hierarchical structure.\n\n")
  }
} else {
  cat("*Shrinkage assessment not available*\n\n")
}
```

---

# All Subjects Summary

```{r all-subjects}
if (!is.null(diagnostic_results$subject_analysis$subject_summaries)) {
  summaries <- diagnostic_results$subject_analysis$subject_summaries
  
  all_df <- data.frame(
    Subject = sapply(summaries, function(x) x$subject_id),
    Status = sapply(summaries, function(x) x$status),
    Worst_Rhat = sprintf("%.4f", sapply(summaries, function(x) x$worst_rhat)),
    Median_Rhat = sprintf("%.4f", sapply(summaries, function(x) x$median_rhat %||% NA)),
    Min_ESS_Bulk = sprintf("%.0f", sapply(summaries, function(x) x$min_ess_bulk %||% NA)),
    Min_ESS_Tail = sprintf("%.0f", sapply(summaries, function(x) x$min_ess_tail %||% NA)),
    Problem_Score = sprintf("%.1f", sapply(summaries, function(x) x$problem_score)),
    stringsAsFactors = FALSE
  )
  
  # Sort by problem score
  all_df <- all_df[order(as.numeric(all_df$Problem_Score), decreasing = TRUE), ]
  
  if (nrow(all_df) <= 50) {
    kable(all_df, row.names = FALSE)
  } else {
    cat(sprintf("\n**Table too large (%d subjects).** Showing top 50:\n\n", nrow(all_df)))
    kable(head(all_df, 50), row.names = FALSE)
    cat(sprintf("\n*Full table with all %d subjects available in CSV export.*\n", nrow(all_df)))
  }
}
```

---

# Recommendations

```{r recommendations}
if (!is.null(diagnostic_results$recommendations)) {
  for (i in seq_along(diagnostic_results$recommendations)) {
    cat(sprintf("%d. %s\n", i, diagnostic_results$recommendations[i]))
  }
} else {
  cat("No specific recommendations.\n")
}
```

---

# Technical Details

## Hierarchical Structure

```{r hier-structure}
cat(sprintf("- **Fit type**: %s\n", diagnostic_results$fit_type))
cat(sprintf("- **Number of subjects**: %d\n", diagnostic_results$n_subjects))
cat(sprintf("- **Parameters per subject**: %d\n", 
            diagnostic_results$subject_analysis$aggregate$n_params_per_subject))

if (!is.null(diagnostic_results$group_analysis)) {
  cat(sprintf("- **Group-level parameters**: %d\n", 
              diagnostic_results$group_analysis$n_params))
}
```

---

**Report generated:** `r format(Sys.time(), "%Y-%m-%d %H:%M:%S")`
